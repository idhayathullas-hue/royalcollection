<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saree Availability - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="index.html">Saree Availability System - Admin Panel</a></h1>
            <div style="text-align: right; margin-top: 10px;">
                <span id="admin-user" style="color: rgba(255,255,255,0.9); margin-right: 15px;"></span>
                <a href="#" onclick="logout()" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 5px;">Logout</a>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="admin-tabs">
            <button class="tab-button active" onclick="showTab('single-upload')">Single Product Upload</button>
            <button class="tab-button" onclick="showTab('bulk-upload')">Bulk Product Upload</button>
            <button class="tab-button" onclick="showTab('manage-products')">Manage Products</button>
            <button class="tab-button" onclick="showTab('manage-categories')">Manage Categories</button>
        </div>

        <!-- Single Product Upload Tab -->
        <div id="single-upload" class="tab-content active">
            <h2>Add Single Product</h2>
            <form id="single-product-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="single-category">Category:</label>
                    <select id="single-category" required>
                        <option value="">Select Category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="single-day">Day:</label>
                    <select id="single-day" required>
                        <option value="">Select Day</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="single-product-number">Product Number:</label>
                    <input type="number" id="single-product-number" min="1" max="500" required>
                </div>

                <div class="form-group">
                    <label for="single-image">Product Image:</label>
                    <input type="file" id="single-image" accept="image/*" required>
                </div>

                <div class="form-group">
                    <label for="single-status">Availability Status:</label>
                    <select id="single-status">
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                        <option value="hold">Hold</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">Add Product</button>
                <div id="single-message" class="message"></div>
            </form>
        </div>

        <!-- Bulk Upload Tab -->
        <div id="bulk-upload" class="tab-content">
            <h2>Bulk Product Upload</h2>
            <form id="bulk-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="bulk-category">Category:</label>
                    <select id="bulk-category" required>
                        <option value="">Select Category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bulk-day">Day:</label>
                    <select id="bulk-day" required>
                        <option value="">Select Day</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="numbering-mode">Numbering Mode:</label>
                    <select id="numbering-mode" required>
                        <option value="auto">Auto (Sequential)</option>
                        <option value="manual">Manual (Specify starting number)</option>
                    </select>
                </div>

                <div class="form-group" id="starting-number-group">
                    <label for="starting-number">Starting Number:</label>
                    <input type="number" id="starting-number" min="1" max="500" value="1">
                </div>

                <div class="form-group">
                    <label for="bulk-images">Select Images (Multiple):</label>
                    <input type="file" id="bulk-images" accept="image/*" multiple required>
                    <small>You can select multiple images at once</small>
                </div>

                <div class="form-group">
                    <label for="bulk-status">Availability Status:</label>
                    <select id="bulk-status">
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                        <option value="hold">Hold</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">Upload Products</button>
                <div id="bulk-message" class="message"></div>
            </form>
        </div>

        <!-- Manage Products Tab -->
        <div id="manage-products" class="tab-content">
            <h2>Manage Products</h2>
            
            <div class="filter-section">
                <label for="manage-category">Category:</label>
                <select id="manage-category">
                    <option value="">Select Category</option>
                </select>

                <label for="manage-day">Day:</label>
                <select id="manage-day">
                    <option value="">Select Day</option>
                </select>

                <button onclick="loadProductsForManagement()" class="btn-secondary">Load Products</button>
            </div>

            <div id="manage-products-container" class="products-grid">
                <p class="info-message">Select a category and day to manage products.</p>
            </div>
        </div>

        <!-- Manage Categories Tab -->
        <div id="manage-categories" class="tab-content">
            <h2>Manage Categories</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Add Category Section -->
                <div style="background: #f5f5f5; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Add New Category</h3>
                    <form id="add-category-form">
                        <div class="form-group">
                            <label for="new-category-name">Category Name:</label>
                            <input type="text" id="new-category-name" placeholder="e.g., Premium Sarees" required>
                        </div>
                        <button type="submit" class="btn-primary">Add Category</button>
                        <div id="add-category-message" class="message"></div>
                    </form>
                </div>

                <!-- Categories List Section -->
                <div style="background: #f5f5f5; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Existing Categories</h3>
                    <div id="categories-list" style="max-height: 400px; overflow-y: auto;">
                        <p class="info-message">Loading categories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>Admin Settings</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Change Password Section -->
                <div style="background: #f5f5f5; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Change Password</h3>
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password:</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password:</label>
                            <input type="password" id="new-password" minlength="4" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password:</label>
                            <input type="password" id="confirm-password" minlength="4" required>
                        </div>
                        <button type="submit" class="btn-primary">Change Password</button>
                        <div id="password-message" class="message"></div>
                    </form>
                </div>

                <!-- Change Username Section -->
                <div style="background: #f5f5f5; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Change Username</h3>
                    <form id="change-username-form">
                        <div class="form-group">
                            <label for="new-username">New Username:</label>
                            <input type="text" id="new-username" minlength="3" required>
                            <small>Current: <strong id="current-username"></strong></small>
                        </div>
                        <button type="submit" class="btn-primary">Change Username</button>
                        <div id="username-message" class="message"></div>
                    </form>
                </div>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-top: 20px;">
                <h3 style="color: #856404; margin-bottom: 10px;">ℹ️ Admin Credentials</h3>
                <p style="color: #856404; margin-bottom: 10px;">
                    <strong>Username:</strong> idhaya123<br>
                    <strong>Password:</strong> ROYALsarees@92
                </p>
                <p style="color: #856404; font-size: 14px;">
                    You can change these credentials in the Settings tab above.
                </p>
            </div>
        </div>
    </main>

    <!-- Edit Product Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Product</h2>
            <form id="edit-product-form" enctype="multipart/form-data">
                <input type="hidden" id="edit-product-id">
                
                <div class="form-group">
                    <label for="edit-product-number">Product Number:</label>
                    <input type="number" id="edit-product-number" min="1" max="500" required>
                </div>

                <div class="form-group">
                    <label for="edit-image">Product Image (leave empty to keep current):</label>
                    <input type="file" id="edit-image" accept="image/*">
                    <div id="current-image-preview"></div>
                </div>

                <div class="form-group">
                    <label for="edit-status">Availability Status:</label>
                    <select id="edit-status">
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                        <option value="hold">Hold</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">Update Product</button>
                <button type="button" class="btn-danger" onclick="deleteProductHandler()">Delete Product</button>
                <div id="edit-message" class="message"></div>
            </form>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check login status
        function checkAdminLogin() {
            if (!isAdminLoggedIn()) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                adminLogout();
                window.location.href = 'login.html';
            }
        }

        let currentEditProductId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!checkAdminLogin()) {
                return;
            }

            // Display logged in username
            const username = sessionStorage.getItem('admin_username') || 'Admin';
            document.getElementById('admin-user').textContent = 'Logged in as: ' + username;
            
            loadCategoriesForAdmin();
            loadCategoriesList();
            
            // Add category form
            document.getElementById('add-category-form').addEventListener('submit', handleAddCategory);
            
            // Settings forms
            document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
            document.getElementById('change-username-form').addEventListener('submit', handleChangeUsername);
            
            // Display current username in settings
            const currentUser = sessionStorage.getItem('admin_username') || localStorage.getItem('admin_username') || 'admin';
            const currentUsernameEl = document.getElementById('current-username');
            if (currentUsernameEl) {
                currentUsernameEl.textContent = currentUser;
            }
            
            // Single product form
            document.getElementById('single-product-form').addEventListener('submit', handleSingleUpload);
            
            // Bulk upload form
            document.getElementById('bulk-upload-form').addEventListener('submit', handleBulkUpload);
            
            // Edit product form
            document.getElementById('edit-product-form').addEventListener('submit', handleEditProduct);
            
            // Category change handlers
            document.getElementById('single-category').addEventListener('change', function() {
                loadSubcategoriesForAdmin(this.value, 'single-day');
            });
            
            document.getElementById('bulk-category').addEventListener('change', function() {
                loadSubcategoriesForAdmin(this.value, 'bulk-day');
            });
            
            document.getElementById('manage-category').addEventListener('change', function() {
                loadSubcategoriesForAdmin(this.value, 'manage-day');
            });
        });

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function loadCategoriesForAdmin() {
            const categories = getCategories();
            ['single-category', 'bulk-category', 'manage-category'].forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            });
        }

        function loadSubcategoriesForAdmin(categoryId, targetSelectId) {
            if (!categoryId) {
                document.getElementById(targetSelectId).innerHTML = '<option value="">Select Day</option>';
                return;
            }

            const subcategories = getSubcategories(categoryId);
            const select = document.getElementById(targetSelectId);
            select.innerHTML = '<option value="">Select Day</option>';
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `Day ${sub.day_number}`;
                select.appendChild(option);
            });
        }

        async function handleSingleUpload(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('single-message');
            messageDiv.textContent = 'Uploading...';
            messageDiv.className = 'message';

            const subcategoryId = parseInt(document.getElementById('single-day').value);
            const productNumber = parseInt(document.getElementById('single-product-number').value);
            const availabilityStatus = document.getElementById('single-status').value;
            const imageFile = document.getElementById('single-image').files[0];

            if (!imageFile) {
                messageDiv.textContent = 'Please select an image';
                messageDiv.className = 'message error';
                return;
            }

            // Validate image
            const validation = validateImageFile(imageFile);
            if (!validation.valid) {
                messageDiv.textContent = validation.error;
                messageDiv.className = 'message error';
                return;
            }

            try {
                // Convert image to base64
                const imageBase64 = await imageToBase64(imageFile);
                
                const result = createProduct({
                    subcategory_id: subcategoryId,
                    product_number: productNumber,
                    image_path: imageBase64,
                    availability_status: availabilityStatus
                });

                if (result.success) {
                    messageDiv.textContent = 'Product added successfully!';
                    messageDiv.className = 'message success';
                    document.getElementById('single-product-form').reset();
                } else {
                    messageDiv.textContent = result.error || 'Error adding product';
                    messageDiv.className = 'message error';
                }
            } catch (error) {
                messageDiv.textContent = 'Error: ' + error.message;
                messageDiv.className = 'message error';
            }
        }

        async function handleBulkUpload(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('bulk-message');
            const files = document.getElementById('bulk-images').files;
            
            if (files.length === 0) {
                messageDiv.textContent = 'Please select at least one image';
                messageDiv.className = 'message error';
                return;
            }

            messageDiv.textContent = 'Uploading ' + files.length + ' products...';
            messageDiv.className = 'message';

            const subcategoryId = parseInt(document.getElementById('bulk-day').value);
            const numberingMode = document.getElementById('numbering-mode').value;
            const startingNumber = parseInt(document.getElementById('starting-number').value);
            const availabilityStatus = document.getElementById('bulk-status').value;

            let productNumber = numberingMode === 'auto' 
                ? Math.max(getMaxProductNumber(subcategoryId) + 1, startingNumber)
                : startingNumber;

            let uploadedCount = 0;
            const errors = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validate image
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    errors.push(`Invalid file: ${file.name} - ${validation.error}`);
                    continue;
                }

                try {
                    const imageBase64 = await imageToBase64(file);
                    
                    const result = createProduct({
                        subcategory_id: subcategoryId,
                        product_number: productNumber,
                        image_path: imageBase64,
                        availability_status: availabilityStatus
                    });

                    if (result.success) {
                        uploadedCount++;
                        productNumber++;
                    } else {
                        errors.push(`${file.name}: ${result.error}`);
                    }
                } catch (error) {
                    errors.push(`${file.name}: ${error.message}`);
                }
            }

            if (uploadedCount > 0) {
                messageDiv.textContent = `Successfully uploaded ${uploadedCount} product(s)!`;
                messageDiv.className = 'message success';
                if (errors.length > 0) {
                    messageDiv.textContent += '\nErrors: ' + errors.join(', ');
                }
                document.getElementById('bulk-upload-form').reset();
            } else {
                messageDiv.textContent = 'No files were uploaded successfully. ' + errors.join(', ');
                messageDiv.className = 'message error';
            }
        }

        function loadProductsForManagement() {
            const subcategoryId = document.getElementById('manage-day').value;
            if (!subcategoryId) {
                alert('Please select a category and day');
                return;
            }

            const container = document.getElementById('manage-products-container');
            container.innerHTML = '<p class="loading">Loading products...</p>';

            setTimeout(() => {
                const products = getProducts(parseInt(subcategoryId));

                if (products.length === 0) {
                    container.innerHTML = '<p class="info-message">No products found.</p>';
                    return;
                }

                container.innerHTML = '';
                products.forEach(product => {
                    const productCard = createManageProductCard(product);
                    container.appendChild(productCard);
                });
            }, 100);
        }

        function createManageProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card manage-card';
            
            const statusClass = product.availability_status;
            const statusText = product.availability_status.charAt(0).toUpperCase() + product.availability_status.slice(1);
            
            // Escape quotes in image path for HTML
            const imagePath = product.image_path.replace(/'/g, "\\'");
            
            card.innerHTML = `
                <div class="product-image">
                    <img src="${product.image_path}" alt="Product ${product.product_number}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2214%22 dy=%2210.5%22 font-weight=%22bold%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                </div>
                <div class="product-number">${product.product_number}</div>
                <div class="product-status status-${statusClass}">${statusText}</div>
                <button class="btn-edit" onclick="openEditModal(${product.id}, ${product.product_number}, '${product.availability_status}', '${imagePath}')">Edit</button>
            `;
            
            return card;
        }

        function openEditModal(productId, productNumber, status, imagePath) {
            currentEditProductId = productId;
            document.getElementById('edit-product-id').value = productId;
            document.getElementById('edit-product-number').value = productNumber;
            document.getElementById('edit-status').value = status;
            
            const preview = document.getElementById('current-image-preview');
            preview.innerHTML = `<p>Current Image:</p><img src="${imagePath}" style="max-width: 200px; margin-top: 10px; border-radius: 5px;">`;
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditProductId = null;
            document.getElementById('edit-product-form').reset();
            document.getElementById('current-image-preview').innerHTML = '';
        }

        async function handleEditProduct(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('edit-message');
            messageDiv.textContent = 'Updating...';
            messageDiv.className = 'message';

            const productId = parseInt(document.getElementById('edit-product-id').value);
            const productNumber = parseInt(document.getElementById('edit-product-number').value);
            const availabilityStatus = document.getElementById('edit-status').value;
            const imageFile = document.getElementById('edit-image').files[0];

            const updateData = {
                product_number: productNumber,
                availability_status: availabilityStatus
            };

            if (imageFile) {
                const validation = validateImageFile(imageFile);
                if (!validation.valid) {
                    messageDiv.textContent = validation.error;
                    messageDiv.className = 'message error';
                    return;
                }

                try {
                    updateData.image_path = await imageToBase64(imageFile);
                } catch (error) {
                    messageDiv.textContent = 'Error processing image: ' + error.message;
                    messageDiv.className = 'message error';
                    return;
                }
            }

            const result = updateProduct(productId, updateData);

            if (result.success) {
                messageDiv.textContent = 'Product updated successfully!';
                messageDiv.className = 'message success';
                setTimeout(() => {
                    closeEditModal();
                    loadProductsForManagement();
                }, 1500);
            } else {
                messageDiv.textContent = result.error || 'Error updating product';
                messageDiv.className = 'message error';
            }
        }

        function deleteProductHandler() {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            const messageDiv = document.getElementById('edit-message');
            messageDiv.textContent = 'Deleting...';
            messageDiv.className = 'message';

            // Use the deleteProduct function from data.js
            const result = deleteProduct(currentEditProductId);

            if (result && result.success) {
                messageDiv.textContent = 'Product deleted successfully!';
                messageDiv.className = 'message success';
                setTimeout(() => {
                    closeEditModal();
                    loadProductsForManagement();
                }, 1500);
            } else {
                messageDiv.textContent = (result && result.error) || 'Error deleting product';
                messageDiv.className = 'message error';
            }
        }

        // Load categories list for management
        function loadCategoriesList() {
            const categories = getCategories();
            const container = document.getElementById('categories-list');
            
            if (categories.length === 0) {
                container.innerHTML = '<p class="info-message">No categories found. Add a new category to get started.</p>';
                return;
            }
            
            container.innerHTML = '';
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);';
                categoryItem.innerHTML = `
                    <span style="font-weight: 600; color: #333;">${category.name}</span>
                    <button onclick="deleteCategoryHandler(${category.id}, '${category.name.replace(/'/g, "\\'")}')" class="btn-danger" style="padding: 8px 16px; font-size: 12px;">Delete</button>
                `;
                container.appendChild(categoryItem);
            });
        }

        // Handle add category
        function handleAddCategory(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('add-category-message');
            const categoryName = document.getElementById('new-category-name').value.trim();
            
            if (!categoryName) {
                messageDiv.textContent = 'Please enter a category name';
                messageDiv.className = 'message error';
                return;
            }
            
            messageDiv.textContent = 'Adding category...';
            messageDiv.className = 'message';
            
            const result = createCategory(categoryName);
            
            if (result.success) {
                messageDiv.textContent = 'Category added successfully!';
                messageDiv.className = 'message success';
                document.getElementById('add-category-form').reset();
                
                // Reload categories in all dropdowns
                loadCategoriesForAdmin();
                loadCategoriesList();
                
                // Show success message briefly
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, 2000);
            } else {
                messageDiv.textContent = result.error || 'Error adding category';
                messageDiv.className = 'message error';
            }
        }

        // Handle delete category
        function deleteCategoryHandler(categoryId, categoryName) {
            if (!confirm(`Are you sure you want to delete "${categoryName}"?\n\nThis will also delete all 30 days (subcategories) for this category.\n\nNote: Categories with products cannot be deleted.`)) {
                return;
            }
            
            const result = deleteCategory(categoryId);
            
            if (result.success) {
                showNotification('Category deleted successfully!', 'success');
                loadCategoriesForAdmin();
                loadCategoriesList();
            } else {
                alert(result.error || 'Error deleting category');
            }
        }

        // Handle change password
        function handleChangePassword(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('password-message');
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                messageDiv.textContent = 'New passwords do not match!';
                messageDiv.className = 'message error';
                return;
            }
            
            const result = changeAdminPassword(currentPassword, newPassword);
            
            if (result.success) {
                messageDiv.textContent = 'Password changed successfully!';
                messageDiv.className = 'message success';
                document.getElementById('change-password-form').reset();
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, 3000);
            } else {
                messageDiv.textContent = result.error || 'Error changing password';
                messageDiv.className = 'message error';
            }
        }

        // Handle change username
        function handleChangeUsername(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('username-message');
            const newUsername = document.getElementById('new-username').value.trim();
            
            const result = changeAdminUsername(newUsername);
            
            if (result.success) {
                messageDiv.textContent = 'Username changed successfully!';
                messageDiv.className = 'message success';
                document.getElementById('current-username').textContent = newUsername;
                document.getElementById('change-username-form').reset();
                
                // Update session username
                sessionStorage.setItem('admin_username', newUsername);
                document.getElementById('admin-user').textContent = 'Logged in as: ' + newUsername;
                
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, 3000);
            } else {
                messageDiv.textContent = result.error || 'Error changing username';
                messageDiv.className = 'message error';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
